# –ì–æ–ª–æ–≤–Ω–∏–π —Ñ–∞–π–ª –∑–∞–ø—É—Å–∫—É –±–æ—Ç–∞
import asyncio
from aiogram import Bot, Dispatcher
from aiogram.fsm.storage.memory import MemoryStorage
from config import BOT_TOKEN, DATABASE
from database import Database
from handlers import start_router, messages_router

# -----------------------------
# –Ü–Ω—ñ—Ü—ñ–∞–ª—ñ–∑–∞—Ü—ñ—è
# -----------------------------
bot = Bot(token=BOT_TOKEN)  # –°—Ç–≤–æ—Ä–µ–Ω–Ω—è –µ–∫–∑–µ–º–ø–ª—è—Ä—É –±–æ—Ç–∞ –∑ —Ç–æ–∫–µ–Ω–æ–º
storage = MemoryStorage()  # –°—Ç–≤–æ—Ä–µ–Ω–Ω—è —Å—Ö–æ–≤–∏—â–∞ —Å—Ç–∞–Ω—ñ–≤ —É –ø–∞–º'—è—Ç—ñ
dp = Dispatcher(storage=storage)  # –°—Ç–≤–æ—Ä–µ–Ω–Ω—è –¥–∏—Å–ø–µ—Ç—á–µ—Ä–∞ –∑ –≤–∫–∞–∑–∞–Ω–∏–º —Å—Ö–æ–≤–∏—â–µ–º
db = Database(DATABASE)  # –°—Ç–≤–æ—Ä–µ–Ω–Ω—è –µ–∫–∑–µ–º–ø–ª—è—Ä—É –±–∞–∑–∏ –¥–∞–Ω–∏—Ö

# -----------------------------
# –§–æ–Ω–æ–≤–∞ –∑–∞–¥–∞—á–∞ –¥–ª—è —Å–ø–æ–≤—ñ—â–µ–Ω—å
# -----------------------------
async def notify_new_entries():
    """
    –§–æ–Ω–æ–≤–∞ –∑–∞–¥–∞—á–∞ –¥–ª—è –≤—ñ–¥—Å—Ç–µ–∂–µ–Ω–Ω—è –Ω–æ–≤–∏—Ö –∑–∞–ø–∏—Å—ñ–≤ —Ç–∞ –Ω–∞–¥—Å–∏–ª–∞–Ω–Ω—è —Å–ø–æ–≤—ñ—â–µ–Ω—å –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á–∞–º.
    –ü–µ—Ä–µ–≤—ñ—Ä—è—î –±–∞–∑—É –¥–∞–Ω–∏—Ö –∫–æ–∂–Ω—ñ 10 —Å–µ–∫—É–Ω–¥ –Ω–∞ –Ω–∞—è–≤–Ω—ñ—Å—Ç—å –Ω–æ–≤–∏—Ö –∑–∞–ø–∏—Å—ñ–≤.
    """
    await asyncio.sleep(2)  # –ó–∞—Ç—Ä–∏–º–∫–∞ –¥–ª—è –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è
    last_count = len(db.select_data("entries"))  # –ó–±–µ—Ä—ñ–≥–∞—î–º–æ –ø–æ—á–∞—Ç–∫–æ–≤—É –∫—ñ–ª—å–∫—ñ—Å—Ç—å –∑–∞–ø–∏—Å—ñ–≤
    
    while True:  # –ù–µ—Å–∫—ñ–Ω—á–µ–Ω–Ω–∏–π —Ü–∏–∫–ª –ø–µ—Ä–µ–≤—ñ—Ä–∫–∏
        await asyncio.sleep(10)  # –ó–∞—Ç—Ä–∏–º–∫–∞ –º—ñ–∂ –ø–µ—Ä–µ–≤—ñ—Ä–∫–∞–º–∏ (10 —Å–µ–∫—É–Ω–¥)
        
        try:
            # –û—Ç—Ä–∏–º—É—î–º–æ –ø–æ—Ç–æ—á–Ω—ñ –∑–∞–ø–∏—Å–∏
            current_entries = db.select_data("entries")
            current_count = len(current_entries)
            
            # –Ø–∫—â–æ –∑'—è–≤–∏–ª–∏—Å—è –Ω–æ–≤—ñ –∑–∞–ø–∏—Å–∏
            if current_count > last_count:
                new_entries = current_entries[last_count:]  # –û—Ç—Ä–∏–º—É—î–º–æ –Ω–æ–≤—ñ –∑–∞–ø–∏—Å–∏
                
                # –û—Ç—Ä–∏–º—É—î–º–æ –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á—ñ–≤ –∑ —É–≤—ñ–º–∫–Ω–µ–Ω–∏–º–∏ —Å–ø–æ–≤—ñ—â–µ–Ω–Ω—è–º–∏
                notify_users = db.select_data("users", ["chat_id"], "registered = 1 AND notify = 1")
                
                # –ù–∞–¥—Å–∏–ª–∞—î–º–æ —Å–ø–æ–≤—ñ—â–µ–Ω–Ω—è –≤—Å—ñ–º –ø—ñ–¥–ø–∏—Å–∞–Ω–∏–º –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á–∞–º
                if notify_users and len(notify_users) > 0:
                    for entry in new_entries:
                        # –§–æ—Ä–º—É—î–º–æ —Ç–µ–∫—Å—Ç –ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω–Ω—è –ø—Ä–æ –Ω–æ–≤–∏–π –∑–∞–ø–∏—Å
                        text = (
                            f"üÜï **–ù–æ–≤–∏–π –∑–∞–ø–∏—Å –Ω–∞ –∑–∞–Ω—è—Ç—Ç—è!**\n\n"
                            f"üë§ –Ü–º'—è: {entry[1]}\n"
                            f"üìß Email: {entry[2]}\n"
                            f"üìû –¢–µ–ª–µ—Ñ–æ–Ω: {entry[3]}\n"
                            f"üì¶ –ü–æ—Å–ª—É–≥–∞: {entry[4]}"
                        )
                        # –ù–∞–¥—Å–∏–ª–∞—î–º–æ –ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω–Ω—è –∫–æ–∂–Ω–æ–º—É –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á—É
                        for user in notify_users:
                            try:
                                await bot.send_message(user[0], text, parse_mode="Markdown")
                            except Exception as e:
                                print(f"–ü–æ–º–∏–ª–∫–∞ –Ω–∞–¥—Å–∏–ª–∞–Ω–Ω—è –ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω–Ω—è {user[0]}: {e}")
                
                last_count = current_count  # –û–Ω–æ–≤–ª—é—î–º–æ –∫—ñ–ª—å–∫—ñ—Å—Ç—å –∑–∞–ø–∏—Å—ñ–≤
        except Exception as e:
            print(f"–ü–æ–º–∏–ª–∫–∞ –≤ notify_new_entries: {e}")

# -----------------------------
# –ó–∞–ø—É—Å–∫ –±–æ—Ç–∞
# -----------------------------
async def main():
    """
    –ì–æ–ª–æ–≤–Ω–∞ —Ñ—É–Ω–∫—Ü—ñ—è –¥–ª—è –∑–∞–ø—É—Å–∫—É –±–æ—Ç–∞.
    –†–µ—î—Å—Ç—Ä—É—î —Ä–æ—É—Ç–µ—Ä–∏, –∑–∞–ø—É—Å–∫–∞—î —Ñ–æ–Ω–æ–≤—É –∑–∞–¥–∞—á—É —Ç–∞ –ø–æ—á–∏–Ω–∞—î polling.
    """
    # –†–µ—î—Å—Ç—Ä–∞—Ü—ñ—è —Ä–æ—É—Ç–µ—Ä—ñ–≤ (–æ–±—Ä–æ–±–Ω–∏–∫—ñ–≤ –ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω—å)
    dp.include_router(start_router)      # –û–±—Ä–æ–±–Ω–∏–∫–∏ –∫–æ–º–∞–Ω–¥ (/start, /help, /status)
    dp.include_router(messages_router)   # –û–±—Ä–æ–±–Ω–∏–∫–∏ —Ç–µ–∫—Å—Ç–æ–≤–∏—Ö –ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω—å
    
    # –ó–∞–ø—É—Å–∫ —Ñ–æ–Ω–æ–≤–æ—ó –∑–∞–¥–∞—á—ñ –¥–ª—è —Å–ø–æ–≤—ñ—â–µ–Ω—å
    asyncio.create_task(notify_new_entries())
    
    # –í–∏–¥–∞–ª–µ–Ω–Ω—è –≤–µ–±—Ö—É–∫–∞ —Ç–∞ –æ—á–∏—â–µ–Ω–Ω—è —á–µ—Ä–≥–∏ –æ–Ω–æ–≤–ª–µ–Ω—å
    await bot.delete_webhook(drop_pending_updates=True)
    
    print("ü§ñ –ë–æ—Ç –∑–∞–ø—É—â–µ–Ω–æ!")
    print("üìä –°–ø–æ–≤—ñ—â–µ–Ω–Ω—è –ø—Ä–∞—Ü—é—é—Ç—å —á–µ—Ä–µ–∑ –ë–î (–±–µ–∑ –∫–µ—à—É–≤–∞–Ω–Ω—è)")
    
    # –ó–∞–ø—É—Å–∫ polling –¥–ª—è –æ—Ç—Ä–∏–º–∞–Ω–Ω—è –æ–Ω–æ–≤–ª–µ–Ω—å
    await dp.start_polling(bot)

# -----------------------------
# –¢–æ—á–∫–∞ –≤—Ö–æ–¥—É
# -----------------------------
if __name__ == "__main__":
    try:
        asyncio.run(main())  # –ó–∞–ø—É—Å–∫ –≥–æ–ª–æ–≤–Ω–æ—ó —Ñ—É–Ω–∫—Ü—ñ—ó
    except KeyboardInterrupt:  # –û–±—Ä–æ–±–∫–∞ –ø–µ—Ä–µ—Ä–∏–≤–∞–Ω–Ω—è (Ctrl+C)
        print("\nüõë –ë–æ—Ç –∑—É–ø–∏–Ω–µ–Ω–æ")
